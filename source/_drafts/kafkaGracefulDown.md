---
title: Kafka  单副本缩容问题排查
date: 2021-05-18 15:10:37
tags:
  - 故障排查
categories:
  - 稳定性  
  - 故障排查    
  - Kafka   
---

<p></p>
<!-- more -->

{% draft %}
{% enddraft %}

# 目录
<!-- toc -->

#  正文

# 参考
1. [尴尬，在Kafka生产实践中又出问题了](https://mp.weixin.qq.com/s/M1fIC3MR4Mhsw4bPTjVj6Q) 微信
   [尴尬，在Kafka生产实践中又出问题了](https://zhuanlan.zhihu.com/p/565831528)
   
# Draft Here[总结]

### 现象
**Kafka日志集群的扩容和缩容过程中出现的问题。**
由于应用数量增加，导致日志采集程序发送日志到Kafka集群时出现了延迟，影响了TPS，为了避免影响业务，先进行了集群的**扩容**。但是在扩容后，**发现新增加的5台机器中有2台机器的消费发送响应时间明显高于其他机器，为了保证消息服务的稳定性，又进行了缩容，但在使用 kill pid 命令缩容过程中，发生了意外。**

**Java客户端报告了部分分区没有在线Leader，无法成功发送消息的错误，而Go客户端报告了一些分区的错误。**

**基本可以认为是部分分区没有在线Leader,无法成功发送消息。**

### 排查
Kafka分区无法进行故障转移的问题，并解释了其原因。

+ 根因
**分区的isr字段值为1，说明该分区只在一个Broker上存储数据，一旦该Broker下线，由于集群内其他Broker上没有该分区的数据，无法进行故障转移，因为进行故障转移会导致数据丢失。**  
该主题的副本数设置为1是因为集群节点之间复制数据量巨大，为了避免数据在集群之间的大量复制，将该主题的副本数设置为1。

+ 解决办法
**为了解决这个问题，可以在停机之前对主题进行分区移动，将该主题的分区从需要停机的集群中移除。**

### 根因

### 解决方案
+ 根因
**经过分析得出    单副本主题在集群中单台节点下线会引起部分队列无法写入，**

+ 解决办法
**是要先执行主题分区移动，也就是将需要停止的broker上所在的分区移动到其他broker上，这个过程并不会对消息发送，消息消费造成影响。**

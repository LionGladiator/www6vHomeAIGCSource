---
title: 数据库-分库分表
date: 2021-05-26 14:27:23
tags:
  - 分库分表
categories:
  - 中间件
  - DAL
  - 分库分表
---

<p></p>
<!-- more -->


### 分库分表带来的问题 [1]
  - 事务性问题
    - 方案一：尽可能保证一个事务所操作的表分布在一个库中 [规避]
    - 方案二：业务层引入分布式事务组件，如事务性消息、TCC、Seata等
  - 主键唯一性问题
    - 方案一：设置自增步长，采用等差数列递增
    - 方案二：采用全局统一ID生成机制，如UUID、雪花算法、数据库号段等方式
  - **跨库多表join问题**
    - 建议尽可能避免表join操作，可以采用多次查询业务层进行数据组装 [规避]
  - **跨库聚合查询问题**
    - 方案一：赛道赛马机制，每次从N个库表中查询出TOP N数据，然后在业务层代码中进行聚合合并操作
    - 方案二：将经常使用到groupby、orderby字段存储到一个单一库表中，先到单一表中查询出相应数据，然后根据查询到的主键ID，到分库分表中查询详情进行返回



### ShardingSphere-分布式事务 [2]

|          | *LOCAL*          | *XA*            | *BASE*            |
| -------- | ---------------- | --------------- | ----------------- |
| 业务改造 | 无               | 无              | 需要 seata server |
| 一致性   | 不支持           | 支持            | 最终一致          |
| 隔离性   | 不支持           | 支持            | 业务方保证        |
| 并发性能 | 无影响           | 严重衰退        | 略微衰退          |
| 适合场景 | 业务方处理不一致 | 短事务 & 低并发 | 长事务 & 高并发   |


### 分片原则的总结 [3]
1. 尽可能不要使用分片，优先考虑单表优化。[规避]
2. 如果必须使用分片，分片数量应该尽量少，均匀分布在多个数据节点上。
3. 分片规则应提前规划选择，考虑数据增长模式、访问模式、关联性和扩容问题。
4. 避免在一个事务中跨越多个分片。 [规避]
5. 查询条件要优化，避免使用 "SELECT *" 的方式，尽量避免返回大量结果集，并为频繁使用的查询语句建立索引。
6. 通过数据冗余和表分区等方式降低跨库 joins 的可能性。 [规避]
7. 对于有时间特征的数据表，采用时间范围分片，当前活跃数据采用短跨度分片，历史数据采用长跨度分片。
8. 分片的选择应该取决于最频繁的查询 SQL 的条件，避免不带 where 语句的查询 SQL。


## 参考
1. [一文读懂数据库分库分表](https://zhuanlan.zhihu.com/p/535713197)
2. [ShardingSphere-分布式事务](https://shardingsphere.apache.org/document/5.3.2/cn/features/transaction/)
3. [MySQL 大表优化方案（长文）](https://mp.weixin.qq.com/s/cVwyE7_oZ0F8Q1Mg7zClmQ)